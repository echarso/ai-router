apiVersion: apps/v1
kind: Deployment
metadata:
  name: openai-api
  namespace: price-runner
  labels:
    app: openai-api
spec:
  replicas: 1
  selector:
    matchLabels:
      app: openai-api
  template:
    metadata:
      labels:
        app: openai-api
    spec:
      containers:
      - name: openai-api
        image: node:18-alpine
        command: ["node"]
        args:
        - -e
        - |
          const http = require('http');
          const port = 3000;
          
          // OpenAPI specification
          const openApiSpec = {
            openapi: '3.0.0',
            info: {
              title: 'OpenAI-Compatible API',
              version: '1.0.0',
              description: 'Mock OpenAI-compatible API service. No model backend connected yet.',
            },
            servers: [
              {
                url: 'http://bestai.se:8080/v1',
                description: 'Production server (via Envoy Gateway)'
              }
            ],
            paths: {
              '/models': {
                get: {
                  summary: 'List models',
                  description: 'Returns a list of available models',
                  operationId: 'listModels',
                  tags: ['Models'],
                  responses: {
                    '200': {
                      description: 'Successful response',
                      content: {
                        'application/json': {
                          schema: {
                            type: 'object',
                            properties: {
                              object: { type: 'string', example: 'list' },
                              data: {
                                type: 'array',
                                items: {
                                  type: 'object',
                                  properties: {
                                    id: { type: 'string', example: 'mock-model-1' },
                                    object: { type: 'string', example: 'model' },
                                    created: { type: 'integer', example: 1234567890 },
                                    owned_by: { type: 'string', example: 'openai' }
                                  }
                                }
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              },
              '/chat/completions': {
                post: {
                  summary: 'Create chat completion',
                  description: 'Creates a completion for the chat message',
                  operationId: 'createChatCompletion',
                  tags: ['Chat'],
                  requestBody: {
                    required: true,
                    content: {
                      'application/json': {
                        schema: {
                          type: 'object',
                          required: ['model', 'messages'],
                          properties: {
                            model: { type: 'string', example: 'mock-model-1' },
                            messages: {
                              type: 'array',
                              items: {
                                type: 'object',
                                required: ['role', 'content'],
                                properties: {
                                  role: { type: 'string', enum: ['system', 'user', 'assistant'], example: 'user' },
                                  content: { type: 'string', example: 'Hello, how are you?' }
                                }
                              }
                            },
                            temperature: { type: 'number', example: 0.7 },
                            max_tokens: { type: 'integer', example: 100 }
                          }
                        }
                      }
                    }
                  },
                  responses: {
                    '200': {
                      description: 'Successful response',
                      content: {
                        'application/json': {
                          schema: {
                            type: 'object',
                            properties: {
                              id: { type: 'string', example: 'chatcmpl-abc123' },
                              object: { type: 'string', example: 'chat.completion' },
                              created: { type: 'integer', example: 1234567890 },
                              model: { type: 'string', example: 'mock-model-1' },
                              choices: {
                                type: 'array',
                                items: {
                                  type: 'object',
                                  properties: {
                                    index: { type: 'integer', example: 0 },
                                    message: {
                                      type: 'object',
                                      properties: {
                                        role: { type: 'string', example: 'assistant' },
                                        content: { type: 'string', example: 'This is a mock response.' }
                                      }
                                    },
                                    finish_reason: { type: 'string', example: 'stop' }
                                  }
                                }
                              },
                              usage: {
                                type: 'object',
                                properties: {
                                  prompt_tokens: { type: 'integer', example: 0 },
                                  completion_tokens: { type: 'integer', example: 0 },
                                  total_tokens: { type: 'integer', example: 0 }
                                }
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              },
              '/completions': {
                post: {
                  summary: 'Create completion',
                  description: 'Creates a completion for the provided prompt',
                  operationId: 'createCompletion',
                  tags: ['Completions'],
                  requestBody: {
                    required: true,
                    content: {
                      'application/json': {
                        schema: {
                          type: 'object',
                          required: ['model', 'prompt'],
                          properties: {
                            model: { type: 'string', example: 'mock-model-1' },
                            prompt: { type: 'string', example: 'Say hello' },
                            temperature: { type: 'number', example: 0.7 },
                            max_tokens: { type: 'integer', example: 100 }
                          }
                        }
                      }
                    }
                  },
                  responses: {
                    '200': {
                      description: 'Successful response',
                      content: {
                        'application/json': {
                          schema: {
                            type: 'object',
                            properties: {
                              id: { type: 'string', example: 'cmpl-abc123' },
                              object: { type: 'string', example: 'text_completion' },
                              created: { type: 'integer', example: 1234567890 },
                              model: { type: 'string', example: 'mock-model-1' },
                              choices: {
                                type: 'array',
                                items: {
                                  type: 'object',
                                  properties: {
                                    text: { type: 'string', example: 'This is a mock response.' },
                                    index: { type: 'integer', example: 0 },
                                    finish_reason: { type: 'string', example: 'stop' }
                                  }
                                }
                              },
                              usage: {
                                type: 'object',
                                properties: {
                                  prompt_tokens: { type: 'integer', example: 0 },
                                  completion_tokens: { type: 'integer', example: 0 },
                                  total_tokens: { type: 'integer', example: 0 }
                                }
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          };
          
          // Swagger UI HTML
          const swaggerUIHtml = \`<!DOCTYPE html>
          <html>
          <head>
            <title>OpenAI-Compatible API - Swagger UI</title>
            <link rel="stylesheet" type="text/css" href="https://unpkg.com/swagger-ui-dist@5.9.0/swagger-ui.css" />
            <style>
              html { box-sizing: border-box; overflow: -moz-scrollbars-vertical; overflow-y: scroll; }
              *, *:before, *:after { box-sizing: inherit; }
              body { margin:0; background: #fafafa; }
            </style>
          </head>
          <body>
            <div id="swagger-ui"></div>
            <script src="https://unpkg.com/swagger-ui-dist@5.9.0/swagger-ui-bundle.js"></script>
            <script src="https://unpkg.com/swagger-ui-dist@5.9.0/swagger-ui-standalone-preset.js"></script>
            <script>
              window.onload = function() {
                const ui = SwaggerUIBundle({
                  url: '/openapi.json',
                  dom_id: '#swagger-ui',
                  deepLinking: true,
                  presets: [
                    SwaggerUIBundle.presets.apis,
                    SwaggerUIStandalonePreset
                  ],
                  plugins: [
                    SwaggerUIBundle.plugins.DownloadUrl
                  ],
                  layout: "StandaloneLayout"
                });
              };
            </script>
          </body>
          </html>\`;
          
          const server = http.createServer((req, res) => {
            // Set CORS headers
            res.setHeader('Access-Control-Allow-Origin', '*');
            res.setHeader('Access-Control-Allow-Methods', 'GET, POST, OPTIONS');
            res.setHeader('Access-Control-Allow-Headers', 'Content-Type, Authorization');
            
            if (req.method === 'OPTIONS') {
              res.writeHead(200);
              res.end();
              return;
            }
            
            const url = new URL(req.url, \`http://\${req.headers.host}\`);
            
            // Handle /openapi.json endpoint
            if (url.pathname === '/openapi.json' && req.method === 'GET') {
              res.writeHead(200, { 'Content-Type': 'application/json' });
              res.end(JSON.stringify(openApiSpec));
              return;
            }
            
            // Handle /docs endpoint (Swagger UI)
            if (url.pathname === '/docs' && req.method === 'GET') {
              res.writeHead(200, { 'Content-Type': 'text/html' });
              res.end(swaggerUIHtml);
              return;
            }
            
            // Handle /swagger endpoint (redirect to /docs)
            if (url.pathname === '/swagger' && req.method === 'GET') {
              res.writeHead(302, { 'Location': '/docs' });
              res.end();
              return;
            }
            
            // Handle /v1/models endpoint
            if (url.pathname === '/v1/models' && req.method === 'GET') {
              res.writeHead(200, { 'Content-Type': 'application/json' });
              res.end(JSON.stringify({
                object: 'list',
                data: [
                  {
                    id: 'mock-model-1',
                    object: 'model',
                    created: Math.floor(Date.now() / 1000),
                    owned_by: 'openai'
                  },
                  {
                    id: 'mock-model-2',
                    object: 'model',
                    created: Math.floor(Date.now() / 1000),
                    owned_by: 'openai'
                  }
                ]
              }));
              return;
            }
            
            // Handle /v1/chat/completions endpoint
            if (url.pathname === '/v1/chat/completions' && req.method === 'POST') {
              let body = '';
              req.on('data', chunk => { body += chunk.toString(); });
              req.on('end', () => {
                res.writeHead(200, { 'Content-Type': 'application/json' });
                res.end(JSON.stringify({
                  id: 'chatcmpl-' + Math.random().toString(36).substring(7),
                  object: 'chat.completion',
                  created: Math.floor(Date.now() / 1000),
                  model: 'mock-model-1',
                  choices: [{
                    index: 0,
                    message: {
                      role: 'assistant',
                      content: 'This is a mock OpenAI API response. No model is connected yet.'
                    },
                    finish_reason: 'stop'
                  }],
                  usage: {
                    prompt_tokens: 0,
                    completion_tokens: 0,
                    total_tokens: 0
                  }
                }));
              });
              return;
            }
            
            // Handle /v1/completions endpoint
            if (url.pathname === '/v1/completions' && req.method === 'POST') {
              let body = '';
              req.on('data', chunk => { body += chunk.toString(); });
              req.on('end', () => {
                res.writeHead(200, { 'Content-Type': 'application/json' });
                res.end(JSON.stringify({
                  id: 'cmpl-' + Math.random().toString(36).substring(7),
                  object: 'text_completion',
                  created: Math.floor(Date.now() / 1000),
                  model: 'mock-model-1',
                  choices: [{
                    text: 'This is a mock OpenAI API response. No model is connected yet.',
                    index: 0,
                    logprobs: null,
                    finish_reason: 'stop'
                  }],
                  usage: {
                    prompt_tokens: 0,
                    completion_tokens: 0,
                    total_tokens: 0
                  }
                }));
              });
              return;
            }
            
            // Handle /health endpoint
            if (url.pathname === '/health' && req.method === 'GET') {
              res.writeHead(200, { 'Content-Type': 'application/json' });
              res.end(JSON.stringify({ status: 'ok', service: 'openai-api-mock' }));
              return;
            }
            
            // 404 for other paths
            res.writeHead(404, { 'Content-Type': 'application/json' });
            res.end(JSON.stringify({ error: 'Not found' }));
          });
          
          server.listen(port, '0.0.0.0', () => {
            console.log(`Mock OpenAI API server listening on port ${port}`);
          });
        ports:
        - containerPort: 3000
          name: http
        resources:
          requests:
            memory: "64Mi"
            cpu: "50m"
          limits:
            memory: "128Mi"
            cpu: "200m"
        livenessProbe:
          httpGet:
            path: /health
            port: 3000
          initialDelaySeconds: 10
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health
            port: 3000
          initialDelaySeconds: 5
          periodSeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: openai-api-service
  namespace: price-runner
  labels:
    app: openai-api
spec:
  type: ClusterIP
  ports:
  - port: 3000
    targetPort: 3000
    protocol: TCP
    name: http
  selector:
    app: openai-api
